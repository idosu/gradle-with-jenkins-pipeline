#!/usr/bin/env groovy

apply plugin: 'java'
apply plugin: 'jacoco'

repositories {
	mavenCentral()
}

dependencies {
	testCompile 'junit:junit:4.12'
}

ext.limits = [
	'instruction' : 93,
	'branch' : 88,
	'line' : 91,
	'complexity' : 84,
	'method' : 87,
	'class' : 95
]

jacocoTestReport {
	reports.html.enabled true
	
	// This code was copied from https://github.com/springfox/springfox/blob/fb780ee1f14627b239fba95730a69900b9b2313a/gradle/coverage.gradle
	// For now there is no way to fail with jacoco plugin, there is a jira opened https://issues.gradle.org/browse/GRADLE-2783
	reports.xml.enabled true
	doLast {
		def report = reports.xml.destination

		def parser = new XmlParser()
		parser.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd", false);
		parser.setFeature("http://apache.org/xml/features/disallow-doctype-decl", false)

		def results = parser.parse(report)
		
		def counters = results.counter

		def percentage = { type ->
			def curr = counters.find { it.'@type'.equals(type) }

			def covered = 0;
			def missed = 0
			if (curr != null) {
				covered = curr.'@covered' as Double
				missed = curr.'@missed' as Double
			}
			def all = covered + missed

			return all == 0 ? 100.0 : ((covered / (covered + missed)) * 100).round(2)
		}
		
		def metricNames = [
			'instruction',
			'branch',
			'line',
			'complexity',
			'method',
			'class'
		]

		def metrics = [ : ]
		metricNames.each {
			metrics << [ "${it}" : percentage(it.toUpperCase()) ]
		}

		logger.debug("metrics: " + metrics)

		def failures = []
		metrics.each {
			def limit = limits."${it.key}"
			if (it.value < limit) {
				failures << "${it.key} coverage rate is: ${it.value}%, minimum was ${limit}%"
			}
		}

		if (failures) {
			logger.error("Code coverage failed")
			failures.each {
				logger.error("	- ${it}")
			}
			throw new GradleException("Code coverage failed")
		}
	}
}

check.dependsOn jacocoTestReport
